# 领域划分

在进行业务架构设计时，我们需要进行业务域的划分。能否划分出合理、稳定、可持续发展的业务域对于未来平台的发展可谓至关重要。通过事件风暴建立领域模型，合理划分领域逻辑和物理边界，建立领域对象及服务矩阵和服务架构图，定义符合 DDD 分层架构思想的代码结构模型，保证业务模型与代码模型的一致性。通过上述设计思想、方法和过程，指导团队按照 DDD 设计思想完成微服务设计和开发。梳理业务事件，然后将领域对象、业务事件，根据创建者、单一职责、高内聚和松耦合进行归纳分类，最终确定领域边界。

# 通过限界上下文对系统进行垂直方向划分

领域模型是对业务需求的一种抽象，其表达了领域概念、领域规则以及领域概念之间的关系。一个好的领域模型是对统一语言的可视化表示，通过它可以减少需求沟通可能出现的歧义；通过提炼领域知识，并运用抽象的领域模型去表达，就可以达到对领域逻辑的化繁为简。模型是封装，实现了对业务细节的隐藏；模型是抽象，提取了领域知识的共同特征，保留了面对变化时能够良好扩展的可能性。基于领域模型对系统进行垂直划分，例如上述例子中的缓存可以视为一个独立的子系统，它同样拥有自己的业务逻辑和技术实现，因而也可以为其建立属于缓存领域的分层架构。在架构的宏观视角，这个缓存子系统与订单子系统处于同一个抽象层次。这一概念在领域驱动设计中，被称之为限界上下文（Bounded Context）。

![限界上下文](https://s3.ax1x.com/2021/02/04/ylxavQ.png)

DDD 中包括三种类型的 SubDomain，分别为通用(Generic)、支撑(Supporting)和核心(Core)三种类型，这里稍微说明一下这几者的区别：

- 通用(Generic) Domain: 通用 Domain 通常被认为已经被行业解决的问题，如架构设计中的可观测性的 Logging、Metrics 和 Tracing，各种云服务(Cloud Service)等，这些都已经有比较好的实现方案，对接就可以。当然业务上也有，如成熟的行业解决方案，如 ERP、CRM、成熟硬件系统等，你购买就可以啦。
- 支撑(Supporting) Domain：和通用 Domain 类似，但是系统更来自内部或者还需要在通用的基础上进行一些定制开发。如一个电商系统，会员、商品、订单、物流等业务系统，当然还有一些内部开发的技术类型支撑系统。
- 核心(Core) Domain: 也就是我们常说的业务核心，当然如果是技术产品，就是技术核心，这个也就是你最要关注的。

这三者整体关系如下：Core 是最与众不同且花费精力比较多的，在复杂性 Y 维度，我们要避免高复杂度的通用和支撑 Domain，这样会分散你的注意力，同时还要投入非常大的精力，如果确实需要，购买服务的方式可能最佳。

![Model Complexity vs Business Differentiation](https://s1.ax1x.com/2020/09/13/w0LIdf.png)

## 鲁棒图

鲁棒图是需求设计过程中使用的一种方法（鲁棒性分析），通过鲁棒分析法可以让设计人员更清晰、全面了解需求。它通常使用在需求分析后及需求设计前做软件架构分析之用，它主要注重于功能需求的设计分析工作。需求规格说明书为其输入信息，设计模型为其输出信息。它是从功能需求向设计方案过渡的第一步，重点是识别组成软件系统的高级职责模块、规划模块之间的关系。

鲁棒图包含三种图形：边界、控制、实体，三个图形如下：

![](https://i.postimg.cc/zB0LD1Jn/image.png)

- 边界：起与外界交互的作用，它只能与控制对象和执行者有关系
- 控制：对业务控制、流程控制的作用，它能与边界对象和实体对象有关系
- 实体：业务元素的存储对象，与领域模型中的对象有良好的关系。它只能与控制对象有关系

我们在对之前识别出的每个 Use Case，都可以绘制一份鲁棒图。通过绘制鲁棒图，我们可以定义出该场景的涉及到的边界类、控制类以及这些控制类会加工/处理哪些实体对象。我们以邮箱注册账号这个 Case 为例，我们可以简单的绘制出鲁棒图如下：

![](https://i.postimg.cc/dVrLkCsQ/image.png)

## 域划分评估

在领域划分之后往往可以得到一个或多个域划分的方案（或者组合），接下来就是判断哪种划分方案更为合理。主要的判定原则会参照经典的“高内聚、低耦合”的原则，即将绘制每个 Use Case 的时序图，并以域为维度来绘制生命周期线，看域与域之间的调用是否过于频繁？甚至是反复调用不同的域服务？如果存在这种情况，就意味着这两个域之间存在比较严重的耦合。这往往通过直观就能有个大致的判断。如果要从定量角度来分析，可以参考代码圈复杂度的度量算法，我们也可以设定一个“域依赖度”算法，来衡量域与域之间的依赖度。对于依赖度比较高的几个域，我们可以采用：域合并，域拆分或者提取第三方域做依赖倒置等降低耦合。

![](https://i.postimg.cc/MTQWN2n6/image.png)

通过将所有的 Use Case（至少是最关键的一级 Case）绘制完时序图后，我们基本上就可以得到一个经过平衡考量后合理的域划分。

# 领域划分案例

接下来，我们通过对所有实体对象进行分类，就可以完成域划分了。

## 电商系统

比如，主订单、子订单对象可以归类到交易域；买家、卖家对象可以归类到商户域等：

![](https://i.postimg.cc/CLy2Dr6S/image.png)

先行分析实体与事件关系，如下：

- 订单：创建、付款、收款、关单、撤销、退款、查询、充转提
- 商户、用户：查询、鉴权、注册
- 产品：签约、制定计收费规划

![](https://i.postimg.cc/fbr6tz9R/image.png)

当然，最终所有的对象是归类到十个域还是二十个域，从理论上看，可以看做一次排列组合过程。只是，我们往往可以根据以往的经验、业务知识，做一个初始的域划分（但不见得是靠谱的）。因此，我们可以认为一个域实际上是一个或多个实体对象的信息集合，并对所管理的实体对象的生命周期进行管理。

- 一个域管理一个或多个实体对象
- 一个实体对象被一个域进行管理
- 如果出现一个实体对象被多个域进行管理，那么相关域的职责实际上就是存在冲突，存在耦合，相互影响。

## CRM 系统

比如在 CRM 领域，我们按照下面的战略设计图，我会自然的把 CRM 系统划分成销售服务，组织权限服务，营销服务，售卖服务：

![](https://i.postimg.cc/R055KqkF/image.png)

## 国际报税系统

国际报税系统是为跨国公司的驻外出差雇员（系统中被称之为 Assignee）提供方便一体化的税收信息填报平台。客户是一家会计师事务所，该事务所的专员（Admin）通过该平台可以收集雇员提交的报税信息，然后对这些信息进行税务评审。如果 Admin 评审出信息有问题，则返回给 Assignee 重新修改和填报。一旦信息确认无误，则进行税收分析和计算，并获得最终的税务报告提交给当地政府以及雇员本人。

在早期的架构设计时，架构师并没有对整个系统的问题域进行拆分，而是基于用户角色对系统进行了简单粗暴的划分，分为了两个相对独立的子系统：Frond End 与 Office End，这两个子系统单独部署，分别面向 Assignee 与 Admin。系统之间的集成则通过消息和 Web Service 进行通信。两个子系统的开发分属不同的团队，Frond End 由美国的团队负责开发与维护，而 Office End 则由印度的团队负责。整个架构如下图所示：
