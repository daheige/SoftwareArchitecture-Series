# 简单性原则

Donald Knuth 1974 年在 ACM Journal 上发表的文章《Structured Programming with go to Statements》中写道：Premature optimizationComplexity is the root of all evil or: How I Learned to Stop Worrying and Love the Monolith。其意就是在没有量化的性能测试检测出真正存在的性能问题前，各种在代码层面的“炫技式”优化，可能不仅提升不了性能，反而会导致更多 bug。

![重构的危害](https://s1.ax1x.com/2020/03/16/8JFiGQ.png)

复杂性是万恶之源，总结而言，我们在注重整体架构与性能的同时，要避免过早地优化、避免过度优化。

# Istio 化繁为简

lstio 作为 Service Mesh（服务网格）领域最具权威的控制面，基本上提到服务网格，所有人都会不自觉地想到它，从 2017 年发布第一个版本以来，lstio 就有着一个堪称非常优雅的架构设计。服务网格整个系统分为数据面和控制面，前者通过同样是开源的智能代理组件 Envoy 负责进行流量处理。而之所以称之为智能，是因为 Envoy 相对比其它代理比如 Nginx 有着更丰富的治理能力和灵活的配置方式，并且支持各种插件可用于扩展流量治理能力；而控制面在网格系统里则根据功能职能的不同，被划分成以下 5 个核心组件：

![Istio Control Plane](https://s1.ax1x.com/2020/03/16/8JFyLt.png)

- Pilot：控制面的核心组件，负责对接 Envoy 数据面，也可以解析上层抽象出来的 lstio 配置，转换成数据面可以识别的 xDS 协议配置并分发到各个 Envoy；

- Galley：为更好的解耦职责，它在 lstio 1.1 后由仅负责配置验证升级成了控制面的配置管理中心，可以对接不同注册中心，用于为服务网格提供配置输入能力；

- Injector：在 K8s 体系里负责数据面的初始化相关工作，其中 lstio 的核心特性之一 Sidecar 自动注入正是依赖该组件；

- Mixer：是 ilstio 里负责提供策略控制和遥测收集的组件，内部包含两个子组件 —— Telemetry 和 Policy，其中 Telemetry 前者负责监控相关的采集信息的数据聚合以用于对接各种监控后端，而 Policy 负责在服务相互调用过程中对请求进行策略检查，例如鉴权；

- Citadel：负责服务网格里安全相关功能，为服务和用户提供认证和鉴权、管理凭据和 RBAC 等相关能力；

服务网格控制面各个组件被定义得清楚了然，设计之初就已经考虑到各种组件职责解耦、扩展性、安全性等，架构上看起来也非常清晰优雅。在这个架构设计中，究竟存在着什么样的难解之题，迫使 istio 开发团队在 istio 推出将近 3 年之时，决定推翻这个架构设计，重新用起“复古的”单体应用设计？

如果有人问 lstio 在回归单体架构设计后，谁最应该开香槟庆祝的话，我可能会不假思索的说是服务网格的运维人员，如果还要再加一类人，那必须算上 lstio 的开发人员。长期以来，服务网格的运维人员饱受折磨，而这种难言之苦，估计也只有 lstio 的开发同学才能感同深受，试想一下如下场景：正常非服务网格的环境下，当用户部署的一个应用出现调用异常时，只需要简单排查下这个应用自身以及被调用服务端即可，排除网络等基础组件异常的话，问题基本上跑不出这两个应用，原因自然也很容易被定位出来；

现在当用户的应用接入服务网格后，众所周知，在服务网格里的调用模型应该是如下图所示的：

![Istio 调用模型](https://s1.ax1x.com/2020/03/16/8JFHe0.md.png)

此时，如果业务出现调用异常，由于接入服务网格，问题处理人员要确认 lstio 系统是否正常工作，还记得之前介绍过的控制面组件吗，首先需要检查 pilot 是否正常工作，配置是否能下发到 sidecar，然后可能还要检查 galley 组件是否正常同步到服务实例信息，也有可能是 sidecar 注入问题，还需要检查 injector 组件是否正常工作…… 这还只是控制面的排查，涉及到数据面还可能需要排查 Envoy 日志等，不过这不是这次关注的点，暂且先不展开介绍。lstio 控制面的各个组件异常都可能会导致数据面在发起请求调用时出现问题，而控制面组件越多，意味着在排查问题的时候要检查的故障点越多，当然过多的组件设计导致部署难度会增加这点也是毋庸置疑。

在这这份公开的设计文档里，作者一开始便非常明确地提出 istiod 的设计目标：

1. **降低安装复杂度**。单一的二进制文件在安装部署时将会更加简单；
2. **降低配置复杂度**。之前的很大一部分配置文件是用于编排控制面组件，而单体化设计后这部分配置可以被移除，而且新版本的 Istiod 在配置上可能更精简，只需保留一个 mesh.yaml 文件，并且能提供最佳实践配置；
3. **增加控制面可运维性**。通过单体设计后的控制面在类似于金丝雀发布的多控制面场景里显得更加简单；不同的工作负载可以通过 namespace 或者 pod 上的标签设置（也可以是组合匹配）来选择对接不同的控制平面；
4. **提高问题诊断能力**。单个控制面组件意味着出了问题后无需在不同的组件间切换来切换去，排查各种问题，显然这有助于提升问题排查效率；
5. **提高效率和响应速度**。再也不用在各个组件间通过远程调用来传递数据，而且原本不同组件间需要共享的数据，现在也可以安全被共享，而且也会一定程度上加快控制面的启动速度；
6. **消除不必要的耦合**。通过把 Envoy 的启动配置生成移到控制面可以避免 pilot agent 的访问权限问题。（这个设计目标存在争议，有人提出 Envoy 的启动配置跟 pilot 或者 galley 没有直接关系应该单独出文档介绍，也有人认为作者的意图是指说将 injector 组件也合并入 Istiod 组件内）。

![Istiod Architecture](https://s1.ax1x.com/2020/03/16/8JkQTf.png)
